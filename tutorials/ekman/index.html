<html>

	<head>
		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
		<meta name="generator" content="Adobe GoLive 4">
		<title>Csound Internal Mechanics</title>
	</head>

	<body bgcolor="white">
		<h1><font face="Times New Roman">Csound Program Flow</font></h1>
		<p><font size="4" face="Times New Roman"><strong>Rasmus Ekman</strong></font></p>
		<p><font face="Times New Roman">Somebody wanted to know the main program structure of Csound. If you're going to add new ugens you will not need to look at this section, instead see the manual entry <strong>Adding New Modules to Csound</strong>. This is a brief overview of the orch/score parsers, and the program flow during a Csound run; a list of the functions that are called and in which files they reside. It may be of use to programmers who need to get into the parser or event management mechanisms, and need a map of where to begin looking.<br>
		File management, function tables and lots of other essentials are not covered.</font></p>
		<p><font face="Times New Roman">
		<hr>
		</font></p>
		<h2><font face="Times New Roman">CONTENTS</font></h2>
		<ul>
			<a href="#OVERVIEW"><font face="Times New Roman">OVERVIEW</font></a><font face="Times New Roman"><br>
			<a href="#PREPARATIONS">PREPARATIONS</a><br>
			</font>
			<ul>
				<a href="#Parsing_session_options"><font face="Times New Roman">Parsing session options</font></a>
			</ul>
			<ul>
				<a href="#Input_file_parsing_the_score"><font face="Times New Roman">Input file parsing: the score</font></a>
			</ul>
			<ul>
				<a href="#Input_file_parsing_the_orchestra"><font face="Times New Roman">Input file parsing: the orchestra</font></a>
			</ul>
			<ul>
				<a href="#Instrument_templates"><font face="Times New Roman">Instrument templates</font></a>
			</ul>
			<ul>
				<a href="#Opcodes_in_instr_templates"><font face="Times New Roman">Opcodes in instr templates</font></a>
			</ul>
			<ul>
				<a href="#Preparing_for_the_performance"><font face="Times New Roman">Preparing for the performance</font></a>
			</ul>
			<p><a href="#PERFORMANCE"><font face="Times New Roman">PERFORMANCE</font></a></p>
			<ul>
				<a href="#Initialization_of_instr_events"><font face="Times New Roman">Initialization of instr events</font></a>
			</ul>
			<ul>
				<a href="#Score_event_input"><font face="Times New Roman">Score event input</font></a>
			</ul>
			<ul>
				<a href="#Other_events"><font face="Times New Roman">Other events</font></a>
			</ul>
			<p><font face="Times New Roman">&nbsp;<br>
			<a href="#CS_H">STRUCTS FROM <b>CS.H</b></a></font></p>
			<ul>
				<a href="#OPDS"><font face="Times New Roman"><tt>OPDS</tt></font></a><font face="Times New Roman"><tt> </tt></font><font face="Times New Roman">&nbsp;</font>
			</ul>
			<ul>
				<a href="#EVTBLK"><font face="Times New Roman"><tt>EVTBLK</tt></font></a><font face="Times New Roman"><tt> </tt></font><font face="Times New Roman">&nbsp;</font>
			</ul>
			<ul>
				<a href="#INSDS"><font face="Times New Roman"><tt>INSDS</tt></font></a><font face="Times New Roman"> &nbsp;</font>
			</ul>
			<ul>
				<a href="#TEXT"><font face="Times New Roman"><tt>TEXT</tt></font></a><font face="Times New Roman"><tt> </tt></font><font face="Times New Roman">&nbsp;</font>
			</ul>
			<ul>
				<a href="#OPTXT"><font face="Times New Roman"><tt>OPTXT</tt></font></a><font face="Times New Roman"><tt> </tt></font><font face="Times New Roman">&nbsp;</font>
			</ul>
			<ul>
				<a href="#INSTRTXT"><font face="Times New Roman"><tt>INSTRTXT</tt></font></a><font face="Times New Roman"><tt> </tt></font><font face="Times New Roman">&nbsp;</font>
			</ul>
		</ul>
		<p><font face="Times New Roman">
		<hr>
		<a name="OVERVIEW"></a></font></p>
		<h2><font face="Times New Roman">OVERVIEW</font></h2>
		<p><font face="Times New Roman"><strong>main(&nbsp;)</strong> (in <strong>Main.c</strong>) collects and checks command line options, opens input files, reads and sorts score etc.</font></p>
		<p><font face="Times New Roman">The last few lines of <strong>main(&nbsp;)</strong> calls <strong>otran(&nbsp;)</strong> (in <strong>Otran.c</strong>) and <strong>musmon(&nbsp;)</strong> (in <strong>Musmon.c</strong>).</font></p>
		<p><font face="Times New Roman"><strong>otran(&nbsp;)</strong> is top of orchestra parsing;</font></p>
		<p><font face="Times New Roman"><strong>musmon(&nbsp;)</strong> does the score playing or &quot;performance&quot; part.</font></p>
		<p><font face="Times New Roman"><strong>musmon(&nbsp;)</strong> sets up realtime and/or file output, calls <strong>oload(&nbsp;)</strong> (in <strong>Oload.c</strong>) to initialise all opcodes (get ftables, set defaults etc), and then calls <strong>playevents(&nbsp;)</strong> (in <strong>Musmon.c</strong>), which does the actual performance.</font></p>
		<p><font face="Times New Roman">All structs used by Csound to parse the score and orchestra files, and maintain the performance, are declared in the <strong>Cs.h</strong> header file.</font></p>
		<p><font face="Times New Roman">Now for some more details.</font></p>
		<p><font face="Times New Roman">
		<hr>
		<a name="PREPARATIONS"></a></font></p>
		<h2><font face="Times New Roman">PREPARATIONS</font></h2>
		<p><font face="Times New Roman"><a name="Parsing_session_options"></a></font></p>
		<h3><font face="Times New Roman">Parsing session options</font></h3>
		<p><font face="Times New Roman"><strong>main(&nbsp;)</strong> calls <strong>readOptions(&nbsp;)</strong> (in <strong>one_file.c</strong>) to read the <strong>.csoundrc</strong> file.</font></p>
		<p><font face="Times New Roman"><strong>argdecode(&nbsp;)</strong> (in <strong>Argdecode.c</strong>) parses the command line. If <strong>Winsound</strong> is invoked, <strong>cwin_args(&nbsp;)</strong> (in&nbsp;<strong>Cwin.cpp</strong>) is called (via <strong>dialog_arguments(&nbsp;)</strong> in Main.c) to show the Winsound dialog. This is the entry point of Winsound performance, which is not covered further here.)</font></p>
		<p><font face="Times New Roman">If a <strong>.csd</strong> file is used for orc/score, <strong>read_unified_file(&nbsp;)</strong> (in&nbsp;<strong>one_file.c</strong>) is called to split it into temporary orc/sco files and collect any further program options.</font></p>
		<p><font face="Times New Roman">The options for the session is stored in the global variable <strong>O</strong>, of type struct <strong>OPARMS</strong>, (declared&nbsp;in&nbsp;<strong>Cs.h</strong>).</font></p>
		<p><font face="Times New Roman">After this, the collected info is checked for consistency (eg of sr/kr/ksmps and output soundfile options) and existence of input files, etc.</font></p>
		<p><font face="Times New Roman">Note that any options appearing in several places will overwrite previous assigment of the same value. The order of precedence of options is:</font></p>
		<ul>
			<li><font face="Times New Roman"><strong>.csd</strong> file <strong><csoptions></strong>tag,</font>
			<li><font face="Times New Roman">command line (or <strong>Winsound</strong> dialog),</font>
			<li><font face="Times New Roman"><strong>.csoundrc</strong> file,</font>
			<li><font face="Times New Roman">program default value.</font>
		</ul>
		<p><font face="Times New Roman"><a name="Input_file_parsing_the_score"></a></font></p>
		<h3><font face="Times New Roman">Input file parsing: the score</font></h3>
		<p><font face="Times New Roman">After program options are collected, main(&nbsp;) calls <strong>scsort(&nbsp;)</strong> (in&nbsp;<strong>Scsort.c</strong>). This short function just calls <strong>sread(&nbsp;)</strong> (in <strong>Sread.c)</strong> to read the score by the section. This function does all textual score preprocessing, including macro expansion, score maths operations, as well as syntax checks.</font></p>
		<p><font face="Times New Roman">For each score section, <strong>scsort(&nbsp;)</strong> calls <strong>sort(&nbsp;)</strong>, <strong>twarp(&nbsp;)</strong> and <strong>swrite(&nbsp;)</strong>. Any time-warping (see&nbsp;eg&nbsp;<strong>t&nbsp;</strong>statement) is straightened out in <strong>twarp(&nbsp;)</strong>, and all events are sorted into strict starting-time order. The score event list is then written to a temporary file <strong>score.srt</strong>, which is closed, and then reopened to get new events during program run. (The functions reside in <strong>Twarp.c</strong>, <strong>Sort.c</strong> and <strong>Swrite.c</strong>, respectively.)</font></p>
		<p><font face="Times New Roman"><a name="Input_file_parsing_the_orchestra"></a></font></p>
		<h3><font face="Times New Roman">Input file parsing: the orchestra</font></h3>
		<p><font face="Times New Roman"><strong>otran(&nbsp;)</strong> (in Otran.c) calls <strong>rdorchfile(&nbsp;)</strong> to input the full orchestra text, then it repeatedly calls <strong>getoptxt(&nbsp;)</strong> to get single lines of instrument code (both functions are in <strong>Rdorch.c</strong>).</font></p>
		<p><font face="Times New Roman"><strong>rdorchfile(&nbsp;)</strong> does the macro collection and substitution, strips comments etc to get clean preprocessed orchestra code. <strong>getoptxt(&nbsp;)</strong> does the orch code parsing and syntax checks.</font></p>
		<p><font face="Times New Roman">From the orch text lines, <strong>otran(&nbsp;)</strong> builds a list of instrument templates, ie the sequence of opcode calls that constitute the instrument's performance.</font></p>
		<p><font face="Times New Roman"><a name="Instrument_templates"></a></font></p>
		<h3><font face="Times New Roman">Instrument templates</font></h3>
		<p><font face="Times New Roman">The text of each <strong>instr</strong>...<strong>endin</strong> block in the orch file is stored in an <a href="#INSTRTXT">INSTRTXT</a> struct. This begins with the equivalent of an <a href="#OPTXT">OPTXT</a>, followed by some info about the instrument (mostly things relevant for memory allocation: number of labels, max number of opcode arguments etc).</font></p>
		<p><font face="Times New Roman">The instruments are stored in numerical order in a list. The list is accessible throughout performance either by index to an array of pointers: INSTRTXT<strong>&nbsp;<em>*</em></strong><em>instrtxtp[&nbsp;]</em>; or as a linked list via INSTRTXT<strong>&nbsp;</strong><em>instxtanchor</em>. (The <em>instrtxtp</em> array will contain null pointers for each instr in range 0 through to <em>maxinsno</em> which has not been defined. There used to be a hardcoded maximum number of instruments (200), but this has recently been made dynamic).</font></p>
		<p><font face="Times New Roman">The INSTRTXT struct of an instr is used as a template from which each new instrument instance is created as required by score (or other) events. (Note that INSTRTXT pointers are typecast to OPTXT structs as deemed convenient.)</font></p>
		<p><font face="Times New Roman"><a name="Opcodes_in_instr_templates"></a></font></p>
		<h3><font face="Times New Roman">Opcodes in instr templates</font></h3>
		<p><font face="Times New Roman">The OPTXT-equiv part of the INSTRTXT holds a chain of <a href="#TEXT">TEXT</a> structs. Each TEXT struct holds the arguments for one opcode in the instrument. As they are encountered by the parser (<strong>otran(&nbsp;)</strong>), orchestra variable names (eg <em>garvb</em>, <em>kamp</em> etc) and pointers to their values are stored in four lists:</font></p>
		<ul>
			<li><font face="Times New Roman">numerical constants (eg &quot;0&quot;, &quot;3.1416&quot;),</font>
			<li><font face="Times New Roman">global variables (gi/gk/ga&nbsp;type),</font>
			<li><font face="Times New Roman">instrument label names,</font>
			<li><font face="Times New Roman">instrument-local variables (i/k/a&nbsp;type), and p-arguments (eg&nbsp;<em>p3</em>)</font>
		</ul>
		<p><font face="Times New Roman">The ARGLST and ARGOFFS in/out lists in the TEXT struct of an opcode contains pointers to the names and the values of opcode arguments in these lists. (The lists are declared locally in Otran.c, some relevant structs and constants are in <strong>Oload.h</strong>.)</font></p>
		<p><font face="Times New Roman">So, all arguments to an opcode are stored as pointers to the actual constant or variable value in the appropriate list, and their names are also kept around throughout performance. This is set up in <strong>insprep(&nbsp;)</strong> (in&nbsp;<strong>Otran.c</strong>), which is called from <strong>otran(&nbsp;)</strong> after reading the orchestra. (See also the support functions <strong>lgbuild(&nbsp;)</strong>, <strong>plgndx(&nbsp;)</strong> etc in <strong>Otran.c</strong>.)</font></p>
		<p><font face="Times New Roman"><a name="Preparing_for_the_performance"></a></font></p>
		<h3><font face="Times New Roman">Preparing for the performance</font></h3>
		<p><font face="Times New Roman"><strong>musmon(&nbsp;)</strong> sets up realtime and/or file output, and calls <strong>oload(&nbsp;)</strong> (in <strong>Oload.c</strong>) to initialize &quot;instr&nbsp;0&quot;. This is the instrument which contains all <strong>instr</strong>-<strong>endin</strong> blocs and the orchestra header statements. <strong>oload(&nbsp;)</strong> also allocates memory for global names in orch code, data space for all a-rate arguments etc.</font></p>
		<p><font face="Times New Roman"><strong>musmon(&nbsp;)</strong> then calls <strong>playevents(&nbsp;)</strong> (in <strong>Musmon.c</strong>), which does the actual performance.</font></p>
		<p><font face="Times New Roman"><a name="PERFORMANCE"></a>
		<hr>
		</font></p>
		<h2><font face="Times New Roman">PERFORMANCE</font></h2>
		<p><font face="Times New Roman">playevents(&nbsp;)</strong> collects several kinds of input: MIDI (file or live input) events, score events from the sorted .sco file, or score events started in realtime by various means. The user arguments of each event is passed around in an <a href="#EVTBLK">EVTBLK</a> struct. <strong>playevents(&nbsp;)</strong> switches on the score event type (i,&nbsp;f,&nbsp;s,&nbsp;t&nbsp;etc) to determine action. Most event types except i-&nbsp;(instr) and f-statements (ftables) are handled locally.</font></p>
		<p><font face="Times New Roman"><strong>playevents(&nbsp;)</strong> also counts up the k-rate clock <em>kcounter</em>, and calls <strong>kperf(&nbsp;)</strong> (in <strong>Insert.c</strong>). <strong>kperf(&nbsp;)</strong> goes through the k-rate opcode list of each active instrument in the playlist (see below), and makes the actual calls to the k- and a-rate opcode functions used by each instrument. It returns to <strong>playevents(&nbsp;)</strong> for each event scheduled from score (instrument turnon, ftable generation, or instrument turnoff). It may also return early if a &quot;realtime&quot; event is detected (this includes MIDI input or MIDI file events, and live text input through a named pipe).</font></p>
		<p><font face="Times New Roman"><a name="Initialization_of_instr_events"></a></font></p>
		<h3><font face="Times New Roman">Initialization of instr events</font></h3>
		<p><font face="Times New Roman">The INSTRTXT array built up by the orchestra parser holds a raw chain of indexes to the list of opcodes (<strong>opcodlst[&nbsp;]</strong> in <strong>Entry.c</strong>), and all actual opcode arguments input by the user. In performance, however, there is a split between i-time and k-rate opcodes.</font></p>
		<p><font face="Times New Roman"><strong>playevents(&nbsp;)</strong> starts instrument events by calling <strong>insert(&nbsp;)</strong> (in <strong>Insert.c</strong>), passing the <a href="#EVTBLK">EVTBLK</a> for the concrete event. This function creates or reuses or ties instruments. To get a new instrument performance copy it calls <strong>instance(&nbsp;)</strong> (in&nbsp;<strong>Oload.c</strong>) to allocate memory for opcodes, get ftables etc.</font></p>
		<p><font face="Times New Roman">In <strong>instance(&nbsp;)</strong> the requested instrument template (<a href="#INSTRTXT">INSTRTXT</a> struct) is used to init an (<a href="#INSDS">INSDS</a> struct. The INSDS struct has one <a href="#OPDS">OPDS</a> struct chain (&quot;thread&quot;) for i-time opcodes, and one for k-rate (a-rate opcodes are of course called at k-rate). It also has pointers for the lists in which it can appear: The list of all allocated instrument instances in performance, and the list of currently active instr instances.</font></p>
		<p><font face="Times New Roman"><strong>insert(&nbsp;)</strong> then calls all the i-time opcodes with the user arguments in the concrete EVTBLK to init the instrument for performance.</font></p>
		<p><font face="Times New Roman">If there are five events of instr 7, it will thus exist in five (simultaneous or sequentially used) copies throughout the performance. If copies are sequentially used, the instrument data space may be taken over by a later instr copy.</font></p>
		<p><font face="Times New Roman"><a name="Score_event_input"></a></font></p>
		<h3><font face="Times New Roman">Score event input</font></h3>
		<p><font face="Times New Roman">During performance, <strong>Csound</strong> reads all score events from <strong>score.srt</strong> up until the first event <em>after </em>the present k-cycle. The time of the next score event is calculated in k-cycles, and <strong>kperf(&nbsp;)</strong> is invoked only for the number of k-cycles from present until this next event.</font></p>
		<p><font face="Times New Roman">This has two notable consequences: First, because of this setup, the list of future events is not available to Csound during performance, even when they exist in the (sorted) score. Secondly, the onset time of an event can only occur with k-rate precision. The k-time of an event is clipped, not rounded (probably; this <em>could</em> vary for different event sources). Until recently (Csound&nbsp;<strong>4.03</strong>), this would lead to problems with time drift in scores with a single stream of events at a regular tempo of fractional k-cycles (eg drum loop-type scores).</font></p>
		<p><font face="Times New Roman"><a name="Other_events"></a></font></p>
		<h3><font face="Times New Roman">Other events</font></h3>
		<p><font face="Times New Roman">All other events are called &quot;real-time events&quot; in Csound source code. The presently available types are:</font></p>
		<ul>
			<li><font face="Times New Roman">MIDI file events (using command line option <strong>-M</strong>)</font>
			<li><font face="Times New Roman">MIDI live input (using command line option <strong>-F</strong> and <strong>MIDI converters</strong>)</font>
			<li><font face="Times New Roman">Real-time text line input (through a pipe set with command line option <strong>-L</strong>), and</font>
			<li><font face="Times New Roman">Orchestra-generated events (<strong>schedwhen</strong>, <strong>schedkwhen</strong>).</font>
		</ul>
		<p><font face="Times New Roman">If any of these methods is used to input events, the program option <strong>O.RTevents</strong> is set, together with a flag for each used event source: O.Midiin, O.FMidiin, O.Linein or O.OrcEvents. <strong>kperf(&nbsp;)</strong> will then check all flagged event sources at k-rate.</font></p>
		<p><font face="Times New Roman">
		<hr>
		</font></p>
		<h3><font face="Times New Roman">This exposition could go on and on, but...</font></h3>
		<p><font face="Times New Roman">Most relevant structs are declared in <strong>Cs.h</strong>. As will be evident from the above, they contain pointers to the instrument text, to each other, and to the corresponding opcode functions, so it is fairly easy to see what's going on by single-stepping through a Csound performance in your favourite debugger.</font></p>
		<p><font face="Times New Roman">All this is (scantily, but still) commented in the source, so you'll find your way in the program flow. Changing stuff without breaking it is trickier.</font></p>
		<p><font face="Times New Roman">&nbsp;</font></p>
		<p><font face="Times New Roman">re, 25 Feb 1999 (reviewed April 2000)</font></p>
		<p><font face="Times New Roman">
		<hr>
		<a name="CS_H"></a></font></p>
		<h1><font face="Times New Roman">Structs from CS.H</font></h1>
		<p><font face="Times New Roman">
		<hr>
		</font></p>
		<h2><font face="Times New Roman"><a name="OPDS"></a>OPDS - in Cs.h</font></h2>
		<p><font face="Times New Roman">This struct holds the info for one opcode in a concrete instrument instance in performance.</font></p>
		<pre><font face="Times New Roman">typedef struct opds {</font>
<font face="Times New Roman">	struct opds * nxti;	</font><font color="green" face="Times New Roman">/* Next opcode in init-time chain */</font>
<font face="Times New Roman">	struct opds * nxtp;	</font><font color="green" face="Times New Roman">/* Next opcode in perf-time chain */</font>
<font face="Times New Roman">	SUBR	iopadr;  	</font><font color="green" face="Times New Roman">/* Initialization (i-time) function pointer */</font>
<font face="Times New Roman">	SUBR	opadr;   	</font><font color="green" face="Times New Roman">/* Perf-time (k- or a-rate) function pointer */</font>
<font face="Times New Roman">	<a href="#OPTXT">OPTXT</a> 	*optext;	</font><font color="green" face="Times New Roman">/* Orch file template part for this opcode */</font>
<font face="Times New Roman">	<a href="#INSDS">INSDS</a>	*insdshead;	</font><font color="green" face="Times New Roman">/* Owner instrument instance data structure */</font>
<font face="Times New Roman">} <strong>OPDS</strong>;</font></pre>
		<p><font face="Times New Roman">
		<hr>
		</font></p>
		<h2><font face="Times New Roman"><a name="EVTBLK"></a>EVTBLK - in Cs.h</font></h2>
		<p><font face="Times New Roman">This struct holds the data for one score event.</font></p>
		<pre><font face="Times New Roman">typedef struct event {</font>
<font face="Times New Roman">	char	*strarg;	</font><font color="green" face="Times New Roman">/* Original argument list string of event */</font>
<font face="Times New Roman">	char	opcod;		</font><font color="green" face="Times New Roman">/* Event type */</font>
<font face="Times New Roman">	short	pcnt;   	</font><font color="green" face="Times New Roman">/* Number of p-fields */</font>
<font face="Times New Roman">	float	p2orig;  	</font><font color="green" face="Times New Roman">/* Event start time */</font>
<font face="Times New Roman">	float	p3orig;  	</font><font color="green" face="Times New Roman">/* Length */</font>
<font face="Times New Roman">	float	offtim; 	</font><font color="green" face="Times New Roman">/* k-time to turn off this event */</font>
<font face="Times New Roman">	float	p[PMAX+1];	</font><font color="green" face="Times New Roman">/* All p-fields for this event */</font>
<font face="Times New Roman">} <strong>EVTBLK</strong>;</font></pre>
		<p><font face="Times New Roman">
		<hr>
		</font></p>
		<h2><font face="Times New Roman"><a name="INSDS"></a>INSDS - in Cs.h</font></h2>
		<p><font face="Times New Roman">This struct holds the info for a concrete instrument event instance in performance.</font></p>
		<pre><font face="Times New Roman">typedef struct insds {</font>
<font face="Times New Roman">	struct <a href="#OPDS">opds</a> * nxti;	 	</font><font color="green" face="Times New Roman">/* Chain of init-time opcodes */</font>
<font face="Times New Roman">	struct opds * nxtp; 		</font><font color="green" face="Times New Roman">/* Chain of performance-time opcodes */</font>
<font face="Times New Roman">	struct insds * nxtinstance;	</font><font color="green" face="Times New Roman">/* Next allocated instance */</font>
<font face="Times New Roman">	struct insds * prvinstance; 	</font><font color="green" face="Times New Roman">/* Previous allocated instance */</font>
<font face="Times New Roman">	struct insds * nxtact; 		</font><font color="green" face="Times New Roman">/* Next in list of active instruments */</font>
<font face="Times New Roman">	struct insds * prvact;		</font><font color="green" face="Times New Roman">/* Previous in list of active instruments */</font>
<font face="Times New Roman">	struct insds * nxtoff;		</font><font color="green" face="Times New Roman">/* Next instrument to terminate */</font>
<font face="Times New Roman">	FDCH	fdch;		</font><font color="green" face="Times New Roman">/* Chain of files used by opcodes in this instr */</font>
<font face="Times New Roman">	AUXCH	auxch;	 	</font><font color="green" face="Times New Roman">/* Extra memory used by opcodes in this instr */</font>
<font face="Times New Roman">	MCHNBLK *m_chnbp; 	</font><font color="green" face="Times New Roman">/* MIDI note info block if event started from MIDI */</font>
<font face="Times New Roman">	short	m_pitch;	</font><font color="green" face="Times New Roman">/* MIDI pitch, for simple access */</font>
<font face="Times New Roman">	short	m_veloc;	</font><font color="green" face="Times New Roman">/* ...ditto velocity */</font>
<font face="Times New Roman">	short 	xtratim;	</font><font color="green" face="Times New Roman">/* Extra release time requested with </font><font face="Times New Roman"><strong>xtratim</strong></font><font color="green" face="Times New Roman"> opcode */</font>
<font face="Times New Roman">	short	relesing;	</font><font color="green" face="Times New Roman">/* Flag to indicate we're releasing, test with </font><font face="Times New Roman"><strong>release</strong></font><font color="green" face="Times New Roman"> opcode */</font>
<font face="Times New Roman">	short	insno;		</font><font color="green" face="Times New Roman">/* Instrument number */</font>
<font face="Times New Roman">	short	actflg; 	</font><font color="green" face="Times New Roman">/* Set if instr instance is active (performing) */</font>
<font face="Times New Roman">	float	offbet;		</font><font color="green" face="Times New Roman">/* Time to turn off event, in score beats */</font>
<font face="Times New Roman">	float	offtim;		</font><font color="green" face="Times New Roman">/* Time to turn off event, in seconds (negative on indef/tie) */</font>
<font face="Times New Roman">	struct insds * nxtolap;	</font><font color="green" face="Times New Roman">/* ptr to next overlapping voice */</font>
<font face="Times New Roman">	</font><font color="green" face="Times New Roman">/* end of overlap */</font>
<font face="Times New Roman">	float	p0;		</font><font color="green" face="Times New Roman">/* Copy of required p-field values for quick access */</font>
<font face="Times New Roman">	float	p1;</font>
<font face="Times New Roman">	float	p2;</font>
<font face="Times New Roman">	float	p3;</font>
<font face="Times New Roman">} <strong>INSDS</strong>;</font></pre>
		<p><font face="Times New Roman">
		<hr>
		</font></p>
		<h2><font face="Times New Roman"><a name="TEXT"></a>TEXT, <a name="OPTXT"></a>OPTXT - in Cs.h</font></h2>
		<p><font face="Times New Roman">Storage for parsed orchestra code, for each opcode in an <a href="#INSTRTXT">INSTRTXT</a>.</font></p>
		<pre><font face="Times New Roman">typedef struct text {</font>
<font face="Times New Roman">	short	linenum;	</font><font color="green" face="Times New Roman">/* Line number in orch file (currently buggy!)  */</font>
<font face="Times New Roman">	short	opnum;		</font><font color="green" face="Times New Roman">/* Opcode index in opcodlst[] */</font>
<font face="Times New Roman">	char	*opcod;		</font><font color="green" face="Times New Roman">/* Pointer to opcode name in global pool */</font>
<font face="Times New Roman">	char	*strarg;	</font><font color="green" face="Times New Roman">/* (Unquoted) file name if needed by opcode */</font>
<font face="Times New Roman">	ARGLST	*inlist; 	</font><font color="green" face="Times New Roman">/* Input arguments (pointer to item in name list) */</font>
<font face="Times New Roman">	ARGLST	*outlist;</font>
<font face="Times New Roman">	ARGOFFS	*inoffs; 	</font><font color="green" face="Times New Roman">/* Input args (index into list of values) */</font>
<font face="Times New Roman">	ARGOFFS	*outoffs;</font>
<font face="Times New Roman">	short	xincod;		</font><font color="green" face="Times New Roman">/* Rate switch for multi-rate opcode functions */</font>
<font face="Times New Roman">	char	intype;		</font><font color="green" face="Times New Roman">/* Type of first input argument (g, k, a, w etc) */</font>
<font face="Times New Roman">	char	pftype;		</font><font color="green" face="Times New Roman">/* Type of output argument (k, a etc) */</font>
<font face="Times New Roman">} <strong>TEXT</strong>;	</font>

<font face="Times New Roman">typedef struct op {</font>
<font face="Times New Roman">	struct op * nxtop;</font>
<font face="Times New Roman">	TEXT	t;</font>
<font face="Times New Roman">} <strong>OPTXT</strong>;</font></pre>
		<p><font face="Times New Roman">
		<hr>
		</font></p>
		<h2><font face="Times New Roman"><a name="INSTRTXT"></a>INSTRTXT - in Cs.h</font></h2>
		<p><font face="Times New Roman">This struct is filled out by <strong>otran(&nbsp;)</strong> at orch parse time. It is used as a template for instrument events.</font></p>
		<pre><font face="Times New Roman">typedef struct instr {</font>
<font face="Times New Roman">	<a href="#OPTXT">struct op</a> * nxtop;		</font><font color="green" face="Times New Roman">/* Linked list of instr opcodes */</font>
<font face="Times New Roman">	<a href="#TEXT">TEXT</a>	t;			</font><font color="green" face="Times New Roman">/* Text of instrument (same as in nxtop) */</font>
<font face="Times New Roman">	short	pmax, vmax, pextrab;	</font><font color="green" face="Times New Roman">/* Arg count, size of data for all opcodes in instr */</font>
<font face="Times New Roman">	short	mdepends;		</font><font color="green" face="Times New Roman">/* Opcode type (i/k/a) */</font>
<font face="Times New Roman">	short	lclkcnt, lcldcnt;	</font><font color="green" face="Times New Roman">/* Storage reqs for this instr */</font>
<font face="Times New Roman">	short	lclwcnt, lclacnt;</font>
<font face="Times New Roman">	short	lclfixed, optxtcount;</font>
<font face="Times New Roman">	long	localen;</font>
<font face="Times New Roman">	long	opdstot;	 	</font><font color="green" face="Times New Roman">/* Total size of </font><a href="#OPDS"><font face="Times New Roman">opds</font></a><font color="green" face="Times New Roman"> structs in instr */</font>
<font face="Times New Roman">	long	* inslist;		</font><font color="green" face="Times New Roman">/* Only used in parsing (?) */</font>
<font face="Times New Roman">	float	* psetdata;		</font><font color="green" face="Times New Roman">/* Used for </font><font face="Times New Roman"><strong>pset</strong></font><font color="green" face="Times New Roman"> opcode */</font>
<font face="Times New Roman">	struct <a href="#INSDS">insds</a> * instance;	</font><font color="green" face="Times New Roman">/* Chain of allocated instances of this instr */</font>
<font face="Times New Roman">	struct instr * nxtinstxt;	</font><font color="green" face="Times New Roman">/* Next instrument in orchestra (numerical order) */</font>
<font face="Times New Roman">} <strong>INSTRTXT</strong>;</font></pre>
	</body>

</html>
