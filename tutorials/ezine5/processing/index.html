<html>	<head>		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">		<meta name="generator" content="Adobe GoLive 4">		<title>Csound Magazine</title>		<meta name="author" content="Hans Mikelson">		<meta name="summary" content="On-line magazine with articles on Csound for synthesis, signal processing, real-time performance, composing and programming.">		<meta name="keywords" content="csound, Csound, computer music, software synthesizer, software synth, digital signal processing, DSP, dsp, algorithmic composition, fractal music, electro-acoustic, electronica, signal processing, synthesis, sound design, audio programming">		<meta name="keywords" content="csound, Csound, computer music, software synthesizer, software synth, digital signal processing, DSP, dsp, algorithmic composition, fractal music, electro-acoustic, electronica, signal processing, synthesis, sound design, audio programming">	</head>	<body bgcolor="white" text="black" link="#000040" vlink="#264624" alink="#e9ca18">		<table border="0">			<tr>				<td valign="top" colspan="2"><a href="../index.html"><img src="../figures/logosm.jpg" border="0" width="291" height="29"></a></td>			</tr>			<tr>				<td valign="top"><strong>Columns</strong>					<p><a href="../weekly/index.html">Weekly </a></p>					<p><a href="../beginners/index.html">Beginners </a></p>					<p><a href="../synthesis/index.html">Synthesis </a></p>					<p>Processing</p>					<p><a href="../realtime/index.html">Real-Time </a></p>					<p><strong>Features</strong></p>					<p><a href="../internals/index.html">Internals</a></p>					<p><a href="../composition/index.html">Composition</a></p>					<p><strong>Departments</strong></p>					<p><a href="../links.html">Links </a></p>					<p><a href="../editorial.html">Editorial </a></p>					<p><a href="../contribute.html">Contribute </a></p>					<p><a href="../past.html">Back Issues </a></p>					<p><a href="http://www.csounds.com/"><img src="../figures/csounds1.gif" border="0" width="88" height="31"></a></td>				<td valign="top">					<h2>Pitch and Time Scaling</h2>					<p><i>Hans Mikelson</i></p>					<p><a href="mailto:hans@csounds.com">hans@csounds.com </a></p>					<p><a href="ptscale.orc">ptscale.orc</a> <a href="ptscale.sco">ptscale.sco</a> <a href="http://www.csounds.com/ezine/limit.wav">limit.wav</a> (398K)</p>					<p><strong>Introduction</strong></p>					<p>This article describes one of the techniques used for pitch and time scaling. Pitch and time scaling is sometimes called pitch shifting and time stretching. Pitch scaling refers to raising or lowering the pitch of a sample and time scaling refers to changing the duration of a sample without effecting the pitch. We shall see that these are two closely related processes. The technique presented in this article is in some ways similar to granular synthesis and is sometimes referred to as the granular approach to pitch shifting. It is also called the synchronized overlap and add or SOLA method. I will start out by describing some naive approaches to pitch and time scaling and then develop these into more sophisticated methods.</p>					<p><strong>Changing the pitch by octaves</strong></p>					<p>A naive approach to pitch scaling would involve resampling. To raise the pitch one could discard every other sample. This would effectively double the pitch of the sample while cutting the playing time in half. To lower the pitch one could double each sample or create a duplicate sample. This would lower the pitch by an octave while doubling the playing time of the sample. One of the main limitations to this approach is that the pitch could only be changed by factors of two or by octaves.</p>					<p><strong>Resampling</strong></p>					<p>The first step towards true pitch shifting is to interpolate between the samples. Consider the case where we were lowering the pitch by an octave. Rather than just doubling the number of samples it would have been better to calculate a value for the sample that was half way between the two samples on either side of it. This can be done by imagining the samples are connected by a straight or curved line. By interpolating between samples it is possible to resample the pitch at any frequency. The value of a line or curve joining the samples is calculated to determine the value of the new sample. Csound currently has the capability for both linear and cubic interpolation.</p>					<p><img src="interp.jpg" width="366" height="200"></p>					<pre><strong>Figure 1.</strong>The yellow dots represent interpolating between samples.The red dots represent simple doubling of each sample.</pre>					<p><strong>Time stretching</strong></p>					<p>Now I will discuss time scaling. One silly way to make a sample twice as long would be to just play it through twice. The pitch would be the same but the duration would be twice as long. Of course this would not result in acceptable time scaling for most samples but it does provide the basis for how it can be accomplished. Suppose we take two samples as above but instead of putting them end to end we chop them up into little mini-samples. Then take the first mini-sample from sample 1 and place the first mini-sample from the identical sample 2 after it. Next place the second mini-sample from sample 1 and then the second mini-sample for sample 2. Repeat this until all of both samples have been used up. We now have a sample that is twice as long as the original. If the mini-samples are small enough (10-50 msec.) then it sounds as if the duration of the samples have been doubled without changing the pitch. To shorten a sample we could just throw away every other minisample.</p>					<p><strong>Granulation</strong></p>					<p>Unfortunately when we chopped up the samples into minisamples we introduced a large amount of noise into the signal. Unless we were very careful in mincing our sample there would have been many times when the end of one sample did not line up with the beginning of the next sample. This introduces a discontinuity or miniature click. We have learned in earlier articles how to declick something using envelopes. Declicking is done by rapidly fading out one sample and rapidly fading in the next one. The next step is to apply a mini-envelope to each of the mini-samples. The shape of a sine wave makes a nice envelope for this.</p>					<p><strong>Dual streaming</strong></p>					<p>Our problems are not over yet because in declicking the sound there are now gaps between where one sample fades out and the other sample fades in. This results in a very garbled sound which is fun, but not what we are after at the moment. The solution to this problem is to have two identical streams of minisamples. When one sample fades out another one fades in. That way there are no longer any gaps between the samples.</p>					<p>It would also be nice if the envelopes were flat in the middle section. A sine wave shaped by hyperbolic tangent provides a very nice shape for an envelope.</p>					<p><img src="env.jpg" width="405" height="221"></p>					<pre><strong>Figure 2.</strong>The envelopes for the two sample streams.</pre>					<p><strong>Putting it all together</strong></p>					<p>Everything is now in place to accomplish true pitch and time scaling. For pitch scaling first resample then stretch or shrink the resampled signal until it is back to its original size. The following Csound code accomplishes this</p>					<pre>aphas1 phasor   ifphaphas2 phasor   ifph, .5apos   linseg   0, idur, idur/itstr*srashft1 table3   iaph*aphas1+apos, itabashft2 table3   iaph*aphas2+apos, itab</pre>					<p>Two phasors are generated to sweep the sample table. The variable <strong>apos</strong> is an offset that moves through the table from sample zero to the sample corresponding to the duration of the note divided by the time scaling factor. The variable <strong>iaph</strong> is the amplitude of the phasor in samples. This is the size of the sample segment described above. The variable <strong>itstr</strong> is the time scaling factor. The frequency of the phasors took me a bit of trial and error before I came up with the following relationship</p>					<pre>ipval  =        (ipshft-1)ifph   =        sr/iaph*((itstr-1)/itstr + ipval)</pre>					<p>This seems to work, causing the frequency to double if <strong>ipshift</strong> is two and the frequency to be halved if <strong>ipshift</strong> is one half.</p>					<p>The declick envelopes are generated using two sinusoidal <strong>oscil</strong>'s 180 degrees out of phase with each other. These are shaped with tanh and adjusted so they range approximately from zero to one.</p>					<pre>kdclk1 oscil 1, ifph, 1kdclk2 oscil 1, ifph, 1, .5kdclk1 = (tanh(kdclk1*ismth)+1)*.5kdclk2 = (tanh(kdclk2*ismth)+1)*.5</pre>					<p>Finally the two signals are shaped by the envelopes and combined into a single signal</p>					<pre>aout   =        ashft1*kdclk1 + ashft2*kdclk2</pre>					<p><strong>Limitations</strong></p>					<p>This method has some limitations. Two artifacts I notice immediately are some uneven sound when the frequency is scaled up and some chorusing in the sound perhaps due to overlap of the signals.</p>					<p>There are some problems with this general method of pitch shifting. For one thing when a person sings at different pitches the formants do not change in pitch very much, only the fundamental frequency changes in pitch. When a sample of a voice is pitch scaled with this technique the formants are pitch scaled too. This results in the effect sometimes called munchkinization or chipmunk voice which is an unnatural sounding high voice. This type of pitch scaling tends to sound better when lowering the pitch compared to raising the pitch.</p>					<p><strong>Links</strong></p>					<p><a href="http://www.dspdimension.com/">http://www.dspdimension.com/</a> by Stephen M. Sprenger. An excellent collection of articles on pitch and time scaling.</p>					<p><a href="http://www.cs.ust.hk/~rren/sound_tech/TSM_Paper_Long.htm">http://www.cs.ust.hk/~rren/sound_tech/TSM_Paper_Long.htm</a> An Edge Detection Method for Time Scale Modification of Acoustic Signals REN, Rui. A paper on pitch and time scaling.</td>			</tr>		</table>	</body></html>